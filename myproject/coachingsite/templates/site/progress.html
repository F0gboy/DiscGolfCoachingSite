{% extends "../base/base.html" %}

{% block title %}Progress Tracker{% endblock %}

{% block template %}
<div class="container py-4">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h2 class="mb-0">Progress tracker</h2>
      <div class="text-muted small">
        {% if selected_athlete %}
          {{ selected_athlete.get_full_name|default:selected_athlete.username }}
        {% endif %}
        {% if selected_course_label %}
          &middot; {{ selected_course_label }}
        {% endif %}
      </div>
    </div>

    {% if athletes or course_options %}
      <form method="get" class="d-flex flex-wrap gap-2">
        {% if athletes %}
          <select name="athlete" class="form-select">
            <option value="" {% if not selected_athlete %}selected{% endif %}>Select athlete…</option>
            {% for athlete in athletes %}
              <option value="{{ athlete.id }}" {% if selected_athlete and athlete.id == selected_athlete.id %}selected{% endif %}>
                {{ athlete.get_full_name|default:athlete.username }}
              </option>
            {% endfor %}
          </select>
        {% elif selected_athlete %}
          <input type="hidden" name="athlete" value="{{ selected_athlete.id }}">
        {% endif %}

        {% if course_options %}
          <select name="course" class="form-select">
            <option value="" {% if not selected_course %}selected{% endif %}>All courses</option>
            {% for course in course_options %}
              <option value="{{ course.value }}" {% if selected_course == course.value %}selected{% endif %}>
                {{ course.label }} ({{ course.count }})
              </option>
            {% endfor %}
          </select>
        {% endif %}

        <button class="btn btn-secondary" type="submit">Apply</button>
      </form>
    {% endif %}
  </div>

  <div class="row gy-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <canvas id="progressChart" height="240"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body d-flex flex-column gap-3">
          <div>
            <div class="text-muted text-uppercase small">Rounds tracked</div>
            <div class="fs-2 fw-bold">{{ round_count }}</div>
            {% if selected_course_label and selected_course %}
              <div class="small text-muted">for {{ selected_course_label|lower }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-muted text-uppercase small">Average score</div>
            <div class="fs-4">{% if aggregate.avg_score is not None %}{{ aggregate.avg_score|floatformat:1 }}{% else %}—{% endif %}</div>
          </div>
          <div class="d-flex gap-4">
            <div>
              <div class="text-muted small text-uppercase">Best</div>
              <div class="fs-5">{% if aggregate.best is not None %}{{ aggregate.best }}{% else %}—{% endif %}</div>
            </div>
            <div>
              <div class="text-muted small text-uppercase">Worst</div>
              <div class="fs-5">{% if aggregate.worst is not None %}{{ aggregate.worst }}{% else %}—{% endif %}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if course_stats %}
      <div class="col-12">
        <div class="card">
          <div class="card-header">Course breakdown</div>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">Course</th>
                  <th scope="col">Rounds</th>
                  <th scope="col">Average</th>
                  <th scope="col">Best</th>
                  <th scope="col">Worst</th>
                </tr>
              </thead>
              <tbody>
                {% for stat in course_stats %}
                  <tr>
                    <td>{{ stat.label }}</td>
                    <td>{{ stat.rounds }}</td>
                    <td>{% if stat.avg is not None %}{{ stat.avg|floatformat:1 }}{% else %}—{% endif %}</td>
                    <td>{% if stat.best is not None %}{{ stat.best }}{% else %}—{% endif %}</td>
                    <td>{% if stat.worst is not None %}{{ stat.worst }}{% else %}—{% endif %}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-muted text-center py-4">No course data yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}

    {% if form %}
      <div class="col-12">
        <div class="card">
          <div class="card-header">Log a new round</div>
          <div class="card-body">
            <form method="post" class="row g-3">
              {% csrf_token %}
              <div class="col-md-4">
                <label class="form-label" for="{{ form.course_name.id_for_label }}">Course</label>
                {{ form.course_name }}
                {% if course_suggestions %}
                  <datalist id="courseSuggestions">
                    {% for course in course_suggestions %}
                      <option value="{{ course }}"></option>
                    {% endfor %}
                  </datalist>
                {% endif %}
              </div>
              {% if course_suggestions %}
                <div class="col-md-4">
                  <label class="form-label" for="courseSuggestionSelect">Previously played</label>
                  <select class="form-select" id="courseSuggestionSelect">
                    <option value="">Select course…</option>
                    {% for course in course_suggestions %}
                      <option value="{{ course }}">{{ course }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}
              <div class="col-md-{{ course_suggestions|yesno:'2,3' }}">
                <label class="form-label" for="{{ form.score_relative.id_for_label }}">Score (±)</label>
                {{ form.score_relative }}
              </div>
              <div class="col-md-{{ course_suggestions|yesno:'2,5' }}">
                <label class="form-label" for="{{ form.played_on.id_for_label }}">Date played</label>
                {{ form.played_on }}
              </div>
              <div class="col-12">
                <label class="form-label" for="{{ form.notes.id_for_label }}">Notes</label>
                {{ form.notes }}
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit">Save round</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="col-12">
      <div class="card">
        <div class="card-header">Round history</div>
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Course</th>
                <th scope="col">Score (±)</th>
                <th scope="col">Notes</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in entries %}
                <tr>
                  <td>{{ entry.played_on|date:"M j, Y" }}</td>
                  <td>{{ entry.course_name|default:"—" }}</td>
                  <td class="fw-bold">{{ entry.score_display }}</td>
                  <td>{{ entry.notes|default:"" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-muted text-center py-4">No rounds logged yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
  const chartData = JSON.parse('{{ chart_data|escapejs }}');
  const canvas = document.getElementById('progressChart');
  if (chartData.length) {
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.map(point => point.date),
        datasets: [{
          label: 'Score relative to par',
          data: chartData.map(point => point.score),
          tension: 0.3,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.12)',
          pointRadius: 5,
          pointHoverRadius: 7,
          fill: true,
        }],
      },
      options: {
        scales: {
          y: {
            ticks: {
              callback: value => (value > 0 ? `+${value}` : value),
            },
            title: {
              display: true,
              text: 'Score vs par (lower is better)',
            },
          },
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: context => {
                const point = chartData[context.dataIndex];
                const value = context.parsed.y;
                return `${point.label}: ${value > 0 ? '+' : ''}${value}`;
              },
            },
          },
          title: {
            display: true,
            text: '{{ selected_course_label }}'
          },
        },
      },
    });
  } else {
    canvas.parentElement.innerHTML = '<p class="text-muted mb-0 text-center">No rounds logged yet.</p>';
  }

  const courseSelect = document.getElementById('courseSuggestionSelect');
  const courseInput = document.getElementById('{{ form.course_name.id_for_label }}');
  if (courseSelect && courseInput) {
    courseSelect.addEventListener('change', (event) => {
      if (event.target.value) {
        courseInput.value = event.target.value;
        courseInput.focus();
      }
    });
  }
</script>
{% endblock %}
